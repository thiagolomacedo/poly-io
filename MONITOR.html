<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Poly.io ‚Äî Painel de Monitoramento</title>
<style>
  :root {
    --bg: #0a0d12;
    --surface: #111520;
    --surface2: #161c2a;
    --border: #1e2a3a;
    --accent: #10b981;
    --accent2: #6366f1;
    --warn: #f59e0b;
    --danger: #ef4444;
    --text: #e2e8f0;
    --muted: #64748b;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: 'Segoe UI', system-ui, sans-serif;
    background: var(--bg);
    color: var(--text);
    padding: 30px;
    min-height: 100vh;
  }

  .header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 30px;
    padding-bottom: 20px;
    border-bottom: 1px solid var(--border);
  }

  .header h1 {
    font-size: 1.8rem;
    background: linear-gradient(135deg, #fff, var(--accent2));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  .header-actions {
    display: flex;
    gap: 15px;
    align-items: center;
  }

  .status-badge {
    padding: 6px 14px;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 600;
  }

  .status-badge.online { background: rgba(16, 185, 129, 0.2); color: var(--accent); }
  .status-badge.offline { background: rgba(239, 68, 68, 0.2); color: var(--danger); }
  .status-badge.loading { background: rgba(245, 158, 11, 0.2); color: var(--warn); }

  .btn-refresh {
    padding: 8px 16px;
    background: var(--accent2);
    border: none;
    border-radius: 8px;
    color: #fff;
    cursor: pointer;
    font-size: 0.9rem;
    transition: opacity 0.2s;
  }

  .btn-refresh:hover { opacity: 0.8; }
  .btn-refresh:disabled { opacity: 0.5; cursor: not-allowed; }

  .last-update {
    font-size: 0.8rem;
    color: var(--muted);
  }

  /* Login Form */
  .login-container {
    max-width: 400px;
    margin: 100px auto;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 40px;
    text-align: center;
  }

  .login-container h2 {
    margin-bottom: 10px;
  }

  .login-container p {
    color: var(--muted);
    margin-bottom: 30px;
  }

  .login-input {
    width: 100%;
    padding: 14px;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 8px;
    color: var(--text);
    font-size: 1rem;
    margin-bottom: 15px;
  }

  .login-input:focus {
    outline: none;
    border-color: var(--accent2);
  }

  .btn-login {
    width: 100%;
    padding: 14px;
    background: linear-gradient(135deg, var(--accent2), #8b5cf6);
    border: none;
    border-radius: 8px;
    color: #fff;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
  }

  .login-error {
    color: var(--danger);
    margin-top: 15px;
    font-size: 0.9rem;
  }

  /* Dashboard Grid */
  .dashboard {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 20px;
    margin-bottom: 30px;
  }

  .card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 20px;
  }

  .card.span-2 { grid-column: span 2; }
  .card.span-4 { grid-column: span 4; }

  .card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
  }

  .card-title {
    font-size: 0.8rem;
    text-transform: uppercase;
    letter-spacing: 1px;
    color: var(--muted);
  }

  .card-icon {
    font-size: 1.5rem;
  }

  .card-value {
    font-size: 2.5rem;
    font-weight: 700;
    color: #fff;
    margin-bottom: 5px;
  }

  .card-subtitle {
    font-size: 0.85rem;
    color: var(--muted);
  }

  .card-value.green { color: var(--accent); }
  .card-value.purple { color: var(--accent2); }
  .card-value.yellow { color: var(--warn); }
  .card-value.red { color: var(--danger); }

  /* Progress bars */
  .progress-container {
    margin-top: 15px;
  }

  .progress-label {
    display: flex;
    justify-content: space-between;
    font-size: 0.8rem;
    margin-bottom: 8px;
  }

  .progress-bar {
    height: 8px;
    background: var(--surface2);
    border-radius: 4px;
    overflow: hidden;
  }

  .progress-fill {
    height: 100%;
    border-radius: 4px;
    transition: width 0.5s ease;
  }

  .progress-fill.green { background: var(--accent); }
  .progress-fill.yellow { background: var(--warn); }
  .progress-fill.red { background: var(--danger); }

  /* Stats grid */
  .stats-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 15px;
    margin-top: 15px;
  }

  .stat-item {
    background: var(--surface2);
    padding: 15px;
    border-radius: 8px;
    text-align: center;
  }

  .stat-value {
    font-size: 1.5rem;
    font-weight: 700;
    color: #fff;
  }

  .stat-label {
    font-size: 0.75rem;
    color: var(--muted);
    margin-top: 5px;
  }

  /* Recommendations */
  .recommendations {
    margin-top: 30px;
  }

  .recommendations h2 {
    margin-bottom: 20px;
    color: var(--accent);
  }

  .rec-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 15px;
    display: flex;
    align-items: center;
    gap: 20px;
  }

  .rec-card.ok { border-left: 4px solid var(--accent); }
  .rec-card.warning { border-left: 4px solid var(--warn); }
  .rec-card.danger { border-left: 4px solid var(--danger); }

  .rec-icon {
    font-size: 2rem;
    width: 50px;
    text-align: center;
  }

  .rec-content h3 {
    color: #fff;
    margin-bottom: 5px;
  }

  .rec-content p {
    color: var(--muted);
    font-size: 0.9rem;
  }

  /* History table */
  .history-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 15px;
  }

  .history-table th,
  .history-table td {
    padding: 12px;
    text-align: left;
    border-bottom: 1px solid var(--border);
  }

  .history-table th {
    color: var(--muted);
    font-size: 0.75rem;
    text-transform: uppercase;
  }

  /* Responsive */
  @media (max-width: 1200px) {
    .dashboard { grid-template-columns: repeat(2, 1fr); }
    .card.span-4 { grid-column: span 2; }
  }

  @media (max-width: 768px) {
    .dashboard { grid-template-columns: 1fr; }
    .card.span-2, .card.span-4 { grid-column: span 1; }
    .stats-grid { grid-template-columns: 1fr; }
  }
</style>
</head>
<body>

<!-- Login Form -->
<div id="loginContainer" class="login-container">
  <h2>Painel Admin</h2>
  <p>Fa√ßa login com sua conta admin do Poly.io</p>
  <input type="email" id="email" class="login-input" placeholder="Email">
  <input type="password" id="password" class="login-input" placeholder="Senha">
  <button onclick="login()" class="btn-login">Entrar</button>
  <p id="loginError" class="login-error" style="display: none;"></p>
</div>

<!-- Dashboard (hidden until login) -->
<div id="dashboard" style="display: none;">
  <div class="header">
    <h1>Poly.io Monitor</h1>
    <div class="header-actions">
      <span class="last-update" id="lastUpdate">Carregando...</span>
      <span class="status-badge loading" id="statusBadge">Conectando</span>
      <button class="btn-refresh" id="refreshBtn" onclick="loadStats()">Atualizar</button>
    </div>
  </div>

  <div class="dashboard">
    <!-- Usu√°rios -->
    <div class="card">
      <div class="card-header">
        <span class="card-title">Usu√°rios Total</span>
        <span class="card-icon">üë•</span>
      </div>
      <div class="card-value" id="totalUsers">-</div>
      <div class="card-subtitle"><span id="foundersCount">-</span> fundadores</div>
    </div>

    <div class="card">
      <div class="card-header">
        <span class="card-title">Online Agora</span>
        <span class="card-icon">üü¢</span>
      </div>
      <div class="card-value green" id="onlineUsers">-</div>
      <div class="card-subtitle">conectados</div>
    </div>

    <div class="card">
      <div class="card-header">
        <span class="card-title">Novos Hoje</span>
        <span class="card-icon">‚ú®</span>
      </div>
      <div class="card-value purple" id="newToday">-</div>
      <div class="card-subtitle"><span id="newWeek">-</span> esta semana</div>
    </div>

    <div class="card">
      <div class="card-header">
        <span class="card-title">Conex√µes</span>
        <span class="card-icon">üîó</span>
      </div>
      <div class="card-value" id="connections">-</div>
      <div class="card-subtitle"><span id="rooms">-</span> salas</div>
    </div>

    <!-- io Friend -->
    <div class="card span-2">
      <div class="card-header">
        <span class="card-title">io Friend - Uso Hoje</span>
        <span class="card-icon">ü§ñ</span>
      </div>
      <div class="stats-grid">
        <div class="stat-item">
          <div class="stat-value" id="ioUsersToday">-</div>
          <div class="stat-label">Usu√°rios usando</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="ioMessagesToday">-</div>
          <div class="stat-label">Mensagens</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="ioAvgMessages">-</div>
          <div class="stat-label">M√©dia/usu√°rio</div>
        </div>
      </div>
      <div class="progress-container">
        <div class="progress-label">
          <span>Uso do limite Groq (14.4K/dia)</span>
          <span id="groqUsagePercent">-</span>
        </div>
        <div class="progress-bar">
          <div class="progress-fill green" id="groqProgressBar" style="width: 0%"></div>
        </div>
      </div>
    </div>

    <!-- Cache de Tradu√ß√µes -->
    <div class="card span-2">
      <div class="card-header">
        <span class="card-title">Cache de Tradu√ß√µes</span>
        <span class="card-icon">üåê</span>
      </div>
      <div class="stats-grid">
        <div class="stat-item">
          <div class="stat-value" id="cacheEntries">-</div>
          <div class="stat-label">Entradas</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="cacheHits">-</div>
          <div class="stat-label">Cache Hits</div>
        </div>
        <div class="stat-item">
          <div class="stat-value green" id="cacheSavings">-</div>
          <div class="stat-label">Economia API</div>
        </div>
      </div>
    </div>

    <!-- io Friends criadas -->
    <div class="card">
      <div class="card-header">
        <span class="card-title">io Friends</span>
        <span class="card-icon">üé≠</span>
      </div>
      <div class="card-value purple" id="totalIoFriends">-</div>
      <div class="card-subtitle"><span id="publicIoFriends">-</span> p√∫blicas</div>
    </div>
  </div>

  <!-- Recomenda√ß√µes de Upgrade -->
  <div class="recommendations">
    <h2>Recomenda√ß√µes de Infraestrutura</h2>
    <div id="recommendations">
      <!-- Populated by JS -->
    </div>
  </div>
</div>

<script>
const API_URL = 'https://poly-io-backend.onrender.com/api';
// const API_URL = 'http://localhost:3000/api'; // Dev

let token = localStorage.getItem('poly_admin_token');
let autoRefreshInterval = null;

// Login
async function login() {
  const email = document.getElementById('email').value;
  const password = document.getElementById('password').value;
  const errorEl = document.getElementById('loginError');

  try {
    const res = await fetch(`${API_URL}/auth/login`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email, senha: password })
    });

    const data = await res.json();

    if (!res.ok) {
      errorEl.textContent = data.error || 'Erro ao fazer login';
      errorEl.style.display = 'block';
      return;
    }

    token = data.token;
    localStorage.setItem('poly_admin_token', token);

    document.getElementById('loginContainer').style.display = 'none';
    document.getElementById('dashboard').style.display = 'block';

    loadStats();
    startAutoRefresh();
  } catch (e) {
    errorEl.textContent = 'Erro de conex√£o';
    errorEl.style.display = 'block';
  }
}

// Check if already logged in
if (token) {
  document.getElementById('loginContainer').style.display = 'none';
  document.getElementById('dashboard').style.display = 'block';
  loadStats();
  startAutoRefresh();
}

// Load stats
async function loadStats() {
  const btn = document.getElementById('refreshBtn');
  const badge = document.getElementById('statusBadge');

  btn.disabled = true;
  badge.className = 'status-badge loading';
  badge.textContent = 'Carregando...';

  try {
    const res = await fetch(`${API_URL}/admin/stats`, {
      headers: { 'Authorization': `Bearer ${token}` }
    });

    if (res.status === 403) {
      alert('Acesso negado. Apenas admins podem acessar.');
      logout();
      return;
    }

    if (res.status === 401) {
      logout();
      return;
    }

    const data = await res.json();
    updateDashboard(data);

    badge.className = 'status-badge online';
    badge.textContent = 'Conectado';
    document.getElementById('lastUpdate').textContent =
      'Atualizado: ' + new Date().toLocaleTimeString();
  } catch (e) {
    console.error(e);
    badge.className = 'status-badge offline';
    badge.textContent = 'Erro';
  } finally {
    btn.disabled = false;
  }
}

function updateDashboard(data) {
  // Users
  document.getElementById('totalUsers').textContent = data.users.total;
  document.getElementById('foundersCount').textContent = data.users.founders;
  document.getElementById('onlineUsers').textContent = data.users.online;
  document.getElementById('newToday').textContent = data.users.newToday;
  document.getElementById('newWeek').textContent = data.users.newThisWeek;

  // Connections & Rooms
  document.getElementById('connections').textContent = data.connections;
  document.getElementById('rooms').textContent = data.rooms;

  // io Friend
  document.getElementById('ioUsersToday').textContent = data.ioFriend.usersUsingToday;
  document.getElementById('ioMessagesToday').textContent = data.ioFriend.messagesToday;
  document.getElementById('ioAvgMessages').textContent = data.ioFriend.avgMessagesPerUser;
  document.getElementById('totalIoFriends').textContent = data.ioFriend.totalCreated;
  document.getElementById('publicIoFriends').textContent = data.ioFriend.public;

  // Groq usage estimate
  const groqUsage = (data.ioFriend.messagesToday / data.limits.groq) * 100;
  document.getElementById('groqUsagePercent').textContent = groqUsage.toFixed(1) + '%';
  const groqBar = document.getElementById('groqProgressBar');
  groqBar.style.width = Math.min(groqUsage, 100) + '%';
  groqBar.className = 'progress-fill ' + (groqUsage > 80 ? 'red' : groqUsage > 50 ? 'yellow' : 'green');

  // Cache
  if (data.translationCache) {
    document.getElementById('cacheEntries').textContent = data.translationCache.total_entries || 0;
    document.getElementById('cacheHits').textContent = data.translationCache.total_hits || 0;
    const savings = data.translationCache.total_hits && data.translationCache.total_entries
      ? Math.round((data.translationCache.total_hits / (data.translationCache.total_hits + data.translationCache.total_entries)) * 100)
      : 0;
    document.getElementById('cacheSavings').textContent = savings + '%';
  }

  // Recommendations
  updateRecommendations(data);
}

function updateRecommendations(data) {
  const container = document.getElementById('recommendations');
  let html = '';

  // Backend (Render)
  if (data.users.total < 500) {
    html += createRec('ok', 'üñ•Ô∏è', 'Backend (Render)', 'Free tier OK. Upgrade para Starter quando atingir 500 usu√°rios.');
  } else if (data.users.total < 5000) {
    html += createRec('warning', 'üñ•Ô∏è', 'Backend (Render)', `Com ${data.users.total} usu√°rios, considere upgrade para Starter ($7/m√™s) para eliminar cold starts.`);
  } else {
    html += createRec('danger', 'üñ•Ô∏è', 'Backend (Render)', `Com ${data.users.total} usu√°rios, fa√ßa upgrade para Standard ($25/m√™s) urgente!`);
  }

  // Database
  if (data.users.total < 10000) {
    html += createRec('ok', 'üóÑÔ∏è', 'Banco de Dados (Neon)', 'Free tier OK. Aguenta at√© ~10.000 usu√°rios.');
  } else {
    html += createRec('warning', 'üóÑÔ∏è', 'Banco de Dados (Neon)', `Com ${data.users.total} usu√°rios, considere upgrade para Launch ($19/m√™s).`);
  }

  // Translation
  if (data.users.total < 2000) {
    html += createRec('ok', 'üåê', 'Tradu√ß√£o (Lingva)', `Cache com ${document.getElementById('cacheSavings').textContent} de economia. OK para at√© 2.000 usu√°rios.`);
  } else {
    html += createRec('warning', 'üåê', 'Tradu√ß√£o', 'Considere VPS Hetzner + Lingva pr√≥prio (‚Ç¨3,29/m√™s) para mais controle.');
  }

  // Groq
  const groqUsage = (data.ioFriend.messagesToday / data.limits.groq) * 100;
  if (groqUsage < 50) {
    html += createRec('ok', 'ü§ñ', 'io Friend (Groq)', `Usando ${groqUsage.toFixed(1)}% do limite di√°rio. OpenRouter como fallback pronto.`);
  } else if (groqUsage < 80) {
    html += createRec('warning', 'ü§ñ', 'io Friend (Groq)', `Usando ${groqUsage.toFixed(1)}% do limite. Monitore o OpenRouter fallback.`);
  } else {
    html += createRec('danger', 'ü§ñ', 'io Friend (Groq)', `${groqUsage.toFixed(1)}% do limite! Muitas requisi√ß√µes indo para OpenRouter.`);
  }

  container.innerHTML = html;
}

function createRec(status, icon, title, desc) {
  return `
    <div class="rec-card ${status}">
      <div class="rec-icon">${icon}</div>
      <div class="rec-content">
        <h3>${title}</h3>
        <p>${desc}</p>
      </div>
    </div>
  `;
}

function startAutoRefresh() {
  if (autoRefreshInterval) clearInterval(autoRefreshInterval);
  autoRefreshInterval = setInterval(loadStats, 60000); // 1 min
}

function logout() {
  localStorage.removeItem('poly_admin_token');
  token = null;
  document.getElementById('dashboard').style.display = 'none';
  document.getElementById('loginContainer').style.display = 'block';
  if (autoRefreshInterval) clearInterval(autoRefreshInterval);
}
</script>

</body>
</html>
